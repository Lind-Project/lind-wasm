
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://lind-project.github.io/lind-wasm/internal/3i/">
      
      
        <link rel="prev" href="../wasmtime/">
      
      
        <link rel="next" href="../rawposix/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>Threei and Grate - Lind-Wasm Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/img.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#3i-and-grates" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Lind-Wasm Docs" class="md-header__button md-logo" aria-label="Lind-Wasm Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Lind-Wasm Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Threei and Grate
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/Lind-Project/lind-wasm/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Lind-Wasm Docs" class="md-nav__button md-logo" aria-label="Lind-Wasm Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Lind-Wasm Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Lind-Project/lind-wasm/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Internal Documentation
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Internal Documentation
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../libc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    libc
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../wasmtime/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Wasmtime
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Threei and Grate
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Threei and Grate
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#i-threei" class="md-nav__link">
    <span class="md-ellipsis">
      
        I. ThreeI
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="I. ThreeI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-motivation" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 Motivation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-design-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 Design Goals
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-high-level-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.3 High-level Concepts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-3i-function-calls" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.4 3i Function Calls
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.4 3i Function Calls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#register_handler" class="md-nav__link">
    <span class="md-ellipsis">
      
        register_handler
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy_handler_table_to_cage" class="md-nav__link">
    <span class="md-ellipsis">
      
        copy_handler_table_to_cage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy_data_between_cages" class="md-nav__link">
    <span class="md-ellipsis">
      
        copy_data_between_cages
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_syscall" class="md-nav__link">
    <span class="md-ellipsis">
      
        make_syscall
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trigger_harsh_cage_exit-and-harsh_cage_exit" class="md-nav__link">
    <span class="md-ellipsis">
      
        trigger_harsh_cage_exit and harsh_cage_exit
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ii-prototype-implementation-lind-wasm" class="md-nav__link">
    <span class="md-ellipsis">
      
        II. Prototype Implementation - Lind-Wasm
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="II. Prototype Implementation - Lind-Wasm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-background-wasmtime" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 Background - Wasmtime
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.1 Background - Wasmtime">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#store" class="md-nav__link">
    <span class="md-ellipsis">
      
        Store
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#module-instance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Module &amp; Instance
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vmcontext" class="md-nav__link">
    <span class="md-ellipsis">
      
        VMContext
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#call-stack" class="md-nav__link">
    <span class="md-ellipsis">
      
        Call Stack
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 Implementation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-scenarios-requiring-runtime-lookup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Execution Scenarios Requiring Runtime Lookup
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Execution Scenarios Requiring Runtime Lookup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Execution Flow
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../rawposix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RawPOSIX
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multiprocess-support/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Processing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../signals/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Signals
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../memory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Memory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../contribute/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Contributing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contribute/dev-container/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Development setup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contribute/styleguide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Rust style guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contribute/toolchain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lind toolchain
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contribute/testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contribute/debug-programs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Debug programs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contribute/add-docs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Adding to the docs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contribute/security/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Security policy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contribute/docker-release-workflow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Docker Hub release workflow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contribute/e2e-testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    End-to-End Testing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../community/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Community
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Community
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../community/team/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Team
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../community/conduct/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Code of conduct
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#i-threei" class="md-nav__link">
    <span class="md-ellipsis">
      
        I. ThreeI
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="I. ThreeI">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-motivation" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 Motivation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-design-goals" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 Design Goals
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-high-level-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.3 High-level Concepts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-3i-function-calls" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.4 3i Function Calls
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.4 3i Function Calls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#register_handler" class="md-nav__link">
    <span class="md-ellipsis">
      
        register_handler
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy_handler_table_to_cage" class="md-nav__link">
    <span class="md-ellipsis">
      
        copy_handler_table_to_cage
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy_data_between_cages" class="md-nav__link">
    <span class="md-ellipsis">
      
        copy_data_between_cages
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make_syscall" class="md-nav__link">
    <span class="md-ellipsis">
      
        make_syscall
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#trigger_harsh_cage_exit-and-harsh_cage_exit" class="md-nav__link">
    <span class="md-ellipsis">
      
        trigger_harsh_cage_exit and harsh_cage_exit
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ii-prototype-implementation-lind-wasm" class="md-nav__link">
    <span class="md-ellipsis">
      
        II. Prototype Implementation - Lind-Wasm
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="II. Prototype Implementation - Lind-Wasm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-background-wasmtime" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 Background - Wasmtime
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.1 Background - Wasmtime">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#store" class="md-nav__link">
    <span class="md-ellipsis">
      
        Store
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#module-instance" class="md-nav__link">
    <span class="md-ellipsis">
      
        Module &amp; Instance
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vmcontext" class="md-nav__link">
    <span class="md-ellipsis">
      
        VMContext
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#call-stack" class="md-nav__link">
    <span class="md-ellipsis">
      
        Call Stack
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory" class="md-nav__link">
    <span class="md-ellipsis">
      
        Memory
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 Implementation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-scenarios-requiring-runtime-lookup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Execution Scenarios Requiring Runtime Lookup
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Execution Scenarios Requiring Runtime Lookup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#data-structure" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data structure
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Execution Flow
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/Lind-Project/lind-wasm/edit/main/docs/internal/3i.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


<h1 id="3i-and-grates">3i and Grates</h1>
<h2 id="i-threei">I. ThreeI</h2>
<p>3i (Three-I) provides a general means for <a href="doc/index.md#cage">cages</a> (and <a href="doc/index.md#grates">grates</a>) to make system calls and intercept system calls via a programmable system call table.  The goal is to enable complex functionality without modifying the <a href="doc/index.md#core-concepts">microvisor</a> or increasing the microvisor's trusted computing base. </p>
<h3 id="11-motivation">1.1 Motivation</h3>
<p>In a traditional Linux environment, extending or intercepting system calls (e.g., adding a new filesystem, tracing, or filtering calls) requires kernel modifications or mechanisms such as ptrace, which incur heavy overhead and depend on kernel-level mediation.</p>
<p>3i eliminates these constraints by introducing a user-space routing layer between cages, grates, and the underlying microvisor. Calls can be dispatched directly between grates or delegated to the microvisor when necessary, achieving kernel-level extensibility while keeping all new logic external to the kernel’s TCB.</p>
<h3 id="12-design-goals">1.2 Design Goals</h3>
<p>3i is designed as a <strong>runtime-agnostic</strong> interposition layer that can operate on top of a wide range of isolation backends (e.g., software sandboxes, hardware-assisted memory protection, etc.) to <strong>execute arbitrary code</strong>. Its core goal is to provide a uniform mechanism for inter-cage call routing -- including system call interception, syscall customization, and cross-cage RPC -- without being tied to any specific runtime.</p>
<p>To achieve this, 3i exposes an abstraction that allows runtimes to register arbitrary entry and exit hooks, implemented as plain C-ABI function pointers. These hooks allow each backend to integrate its own cage-management requirements (e.g., switching execution contexts, updating thread-local state, or preparing runtime metadata) into the call path. Because 3i itself never assumes the presence of a particular runtime structure or object model, backend-specific behavior remains fully encapsulated in the corresponding adapter layer, leaving 3i’s core logic small, generic, and portable.</p>
<h3 id="13-high-level-concepts">1.3 High-level Concepts</h3>
<p>[todo]
- add the figure of general lind</p>
<p>In traditional operating systems, a process makes a system call which traps into the kernel.  Every process which makes a system call ends up trapping into the same kernel routine.  In essence, there is one system call table which is shared by every process.</p>
<p>In contrast, in Lind, 3i provides a per-cage, per-system-call table. Each cage may define a function to serve as a system-call handler and register it for a specific system call (via <code>register_handler</code>). As a result, every system call of every cage can have its own distinct handler. When a cage issues a system call (<code>make_syscall</code>), the invocation is dispatched to the handler registered for that particular system call in that particular cage. Because handler tables are cage-local, multiple cages may register different handlers for the same system call without interfering with one another.</p>
<p>Specifically, 3i supports the following scenarios:</p>
<ol>
<li>
<p><strong>Per-call routing within a single cage</strong>:<br />
   Different system calls issued by the same cage can be handled by different grates (or RawPOSIX) by registering distinct handlers for each system call.</p>
</li>
<li>
<p><strong>Shared handlers across multiple cages</strong>:<br />
   Multiple cages may register the same handler function (provided by a grate) by invoking <code>register_handler</code> with different <code>cageid</code>s, enabling controlled sharing of system call implementations across cages.</p>
</li>
</ol>
<p>As a term of convenience, we call a cage which processes system calls a "grate".  This is meant to convey the mental model of a cage calling down towards the microvisor / kernel and having a grate filter or transform or handle those system calls.  However, a grate is simply a cage and there is no special handling code or permission for it in 3i or the rest of the system.  A grate may tend to make different system calls from a normal application, but it is still a cage, much like strace is still a normal Linux process that happens to use system calls like ptrace which are otherwise rare.</p>
<p>One important feature needed by a grate is the ability to read and write the memory of a cage which makes a system call it intercepts.  For example, to handle a write system call, the grate must be able to read data out of the calling cage's buffer, which involves reading the calling cage's memory.  3i provides a function ( copy_data_between_cages ) to enable this feature safely.  </p>
<p>Consider a grate that wishes to count how many times a specific cage invokes the <code>write</code> system call. The grate must increment its counter and then re-issue the <code>write</code> call on behalf of the originating cage. However, copying the user buffer into the grate’s own address space would be wasteful when the grate merely wants to observe and forward the call. To support this use case, <code>make_syscall</code> allows each argument of the system call to be annotated with a source cageid. The grate can therefore perform the forwarded <code>write</code> using its own system-call table while specifying that the buffer pointer resides in the calling cage’s address space. This per-argument cage identifier enables grates to distinguish which cage originated a system call and to safely access or forward data without unnecessary copying. This mechanism is required by many grates that interpose on system calls issued by other cages.</p>
<p>One final important feature of <code>make_syscall</code> is the ability for a grate to perform a system call as though another cage had issued it. Consider the <code>fork</code> system call: if a cage invokes <code>fork</code> and the grate simply executes a native <code>fork</code>, the grate -- not the originating cage -- would be duplicated. To prevent this, each <code>make_syscall</code> invocation explicitly specifies the target cage whose state and identity the system call should operate on.</p>
<p>Finally, 3i functions such as <code>register_handler</code> and <code>copy_data_between_cages</code> are themselves treated as system calls within 3i. They are 3i-specific APIs that participate in the same interception and dispatch framework, enabling grates to interpose on operations performed by other grates. This is the key mechanism that is used to provide security in 3i -- the ability to make a grate that can correctly namespace and enforce protections between cages, including calls to 3i.</p>
<h3 id="14-3i-function-calls">1.4 3i Function Calls</h3>
<p>[todo]:
- a short instruction/example on how to write grates by using those functions</p>
<table>
<thead>
<tr>
<th>Caller</th>
<th>Callee</th>
<th>Function</th>
<th>Interposable</th>
<th>Remarks</th>
</tr>
</thead>
<tbody>
<tr>
<td>grate</td>
<td>3i</td>
<td><code>register_handler</code></td>
<td>Yes</td>
<td>Register a handler for a syscall</td>
</tr>
<tr>
<td>grate</td>
<td>3i</td>
<td><code>copy_handler_table_to_cage</code></td>
<td>Yes</td>
<td>Overwrites the entire syscall handler table of a cage</td>
</tr>
<tr>
<td>grate</td>
<td>3i</td>
<td><code>copy_data_between_cages</code></td>
<td>Yes</td>
<td>Copies memory across cages</td>
</tr>
<tr>
<td>grate</td>
<td>3i</td>
<td><code>make_syscall</code></td>
<td>No</td>
<td>Call the registered handler for a syscall</td>
</tr>
<tr>
<td>WASM / NaCl / RawPOSIX</td>
<td>3i</td>
<td><code>trigger_harsh_cage_exit</code></td>
<td>No</td>
<td>Kill a cage: See detailed explanation below</td>
</tr>
<tr>
<td>3i / grate</td>
<td>grate / RawPOSIX</td>
<td><code>harsh_cage_exit</code></td>
<td>Yes</td>
<td>Notify a cage was killed: See detailed explaination below</td>
</tr>
</tbody>
</table>
<p><em>NOTE:</em> </p>
<p><em>- <em>Interposable</em> in the table means whether these calls are made via the system call table and thus whether or not a grate could alter their behavior</em></p>
<p><em>- <em>Caller</em> denotes the execution context that invokes the function (i.e., the component whose code initiates the transition into 3i or another cage). In other words, it represents the origin of the call site. A caller can be a grate, a normal cage, RawPOSIX, runtime, or 3i itself; the <em>Callee</em> column indicates which subsystem receives and executes the request.</em></p>
<h4 id="register_handler"><code>register_handler</code></h4>
<p>This function registers an interposition rule, mapping a syscall number from a source cage to a handler function in a destination grate or cage. Used for creating per-syscall routing rules that enable one cage to interpose or handle syscalls on behalf of another.</p>
<h4 id="copy_handler_table_to_cage"><code>copy_handler_table_to_cage</code></h4>
<p>This function copies the handler table used by a cage to another cage. This is often useful for calls like fork, so that a grate can later add or remove entries.</p>
<h4 id="copy_data_between_cages"><code>copy_data_between_cages</code></h4>
<p>This function copies memory across cages.  One common use of this is to read arguments which are passed by reference instead of by value.  The source and destination cages may each be different from the calling cage.  This may be useful for some grates.</p>
<h4 id="make_syscall"><code>make_syscall</code></h4>
<p>This function actually performs a 3i call. It is not interposable. This is the most commonly used and simplest API, despite the number of arguments.  All the code here does is route the call to the corresponding handler and deal with error situations.</p>
<p>Note that this call is itself not interposable, since this is the base call used to route other calls and do the interposition.  In theory, this could be changed, but it doesn't seem useful to do so.</p>
<p>This is the main entry point used by cages or grates to invoke system calls through the 3i layer. The function inspects the caller’s interposition configuration (if any) and either routes the syscall to a grate for handling or directly invokes the corresponding function in the RawPOSIX layer.</p>
<h4 id="trigger_harsh_cage_exit-and-harsh_cage_exit"><code>trigger_harsh_cage_exit</code> and <code>harsh_cage_exit</code></h4>
<p>This is essentially a way for grates to clean up if a cage was abruptly killed (perhaps due to a signal).  <code>trigger_harsh_cage_exit</code> is triggered by the caging or signaling infrastructure to indicate that a cage will (uncleanly) exit. After receiving notification, 3i will cleanup the 3i data structure (which is the system call table) and then 3i will go through the respective grates until reaching 3i's version of the call by triggering <code>harsh_cage_exit</code>. This call can be thought of as notifying the grates and microvisor of the harsh exit of a program whose memory state cannot be relied upon. This is unlike the <code>exit_syscall</code>, which is performed by a functioning program with intact memory as part of its termination.</p>
<p><strong>Why not interposable?</strong>
At the time <code>trigger_harsh_cage_exit</code> or <code>harsh_cage_exit</code> is invoked, the target Cage or Grate is assumed to have unreliable memory and control flow. During the execution of these calls, the syscall table of the target cage/grate is either being torn down or may already be corrupted, meaning the call path itself is no longer trustworthy.</p>
<p>The cleanup process must complete system-level invariants such as: unmapping vmmap regions, cleaning fdtables, waking waiters, canceling schedulers or timers, etc. Allowing these calls to be interposable would permit third-party grates to inject arbitrary logic (e.g., blocking, allocation, or reentrancy), which could stall or disrupt the teardown sequence, resulting in resource leaks, deadlocks, or zombie cages/grates.</p>
<h2 id="ii-prototype-implementation-lind-wasm">II. Prototype Implementation - Lind-Wasm</h2>
<p>[todo]
- figure </p>
<h3 id="21-background-wasmtime">2.1 Background - Wasmtime</h3>
<h4 id="store">Store</h4>
<p>In Wasmtime, a <code>Store</code> is the top-level container that owns all runtime objects. A single <code>Store</code> may own multiple <code>Instance</code>s, and every <code>Instance</code> must belong to exactly one <code>Store</code>. All runtime items, such as Functions, Tables, Memories, and Globals, are allocated within the <code>Store</code> and are tied to its lifetime.</p>
<h4 id="module-instance">Module &amp; Instance</h4>
<ul>
<li>A <code>Module</code> is only a compiled binary: it contains code and type information but no runtime state.</li>
<li>An <code>Instance</code> is the executable instantiation of a <code>Module</code> within a <code>Store</code>.</li>
</ul>
<p>You cannot read memory, table, globals, or call functions on a <code>Module</code>. All executable interactions happen through an <code>Instance</code>.</p>
<h4 id="vmcontext">VMContext</h4>
<p>Each <code>Instance</code> has an internal data structure called <code>VMContext</code>. <code>VMContext</code> is a raw pointer used by the JIT-generated machine code. This has information about globals, memories, tables, and other runtime state associated with the current instance.</p>
<h4 id="call-stack">Call Stack</h4>
<p>Although WebAssembly defines an abstract operand stack and structured control flow, Wasmtime lowers all function calls and stack frames to the native call stack of the executing host thread. Each Wasm function is compiled into a normal machine function that receives a <code>VMContext</code> pointer as an implicit first argument. Local variables, temporaries, and control-flow state are therefore represented using standard native stack slots and registers.</p>
<p>Wasmtime attaches a <code>VMRuntimeLimits</code> structure to every <code>VMContext</code>, which stores a stack-limit pointer. At function-entry, compiled code inserts a prologue check comparing the current native stack pointer against this limit; exceeding it triggers a Wasmtime stack-overflow trap rather than a process-level segmentation fault.</p>
<h4 id="memory">Memory</h4>
<p>Wasmtime implements each linear memory as a sandboxed region in the host virtual address space. At instantiation time, the runtime reserves a contiguous virtual range using <code>mmap</code> and commits only the portion required by the module’s initial size.</p>
<p>Each memory is represented internally by a <code>VMMemoryDefinition</code> structure embedded in the instance’s <code>VMContext</code>. The <code>VMContext</code> is passed as an implicit argument to all JIT-compiled functions. Every load or store instruction is lowered to native code that first reads the memory’s base pointer and current length from the <code>VMContext</code>, performs an explicit bounds check, and then translates the Wasm address into a native pointer (<code>base + offset</code>). </p>
<h3 id="22-implementation">2.2 Implementation</h3>
<p><img alt="VMContext Pool Overview" src="docs/images/doc-images/grate-call-vmctx.png" /></p>
<p>Lind-wasm implements a global runtime-state lookup and pooling mechanism for lind-wasm and lind-3i, enabling explicit, controlled transfers of execution across cages, grates, and threads.</p>
<p>Unlike conventional WebAssembly execution models: where control flow is confined to a single Wasmtime <code>Store</code>, <code>Instance</code>, and linear call stack. Lind-wasm supports cross-instance and cross-module execution transfers. These transfers are required to implement POSIX-like process semantics (each process has its own state management) and lind-3i’s inter-cage and inter-grate call model.</p>
<p>To support this, lind-wasm must be able to:</p>
<ul>
<li>Identify the correct Wasmtime runtime state without relying on implicit “current execution context” assumptions</li>
<li>Re-enter an existing Wasm instance from outside its original call stack</li>
<li>Support concurrent execution paths that operate on shared Wasm linear memory</li>
</ul>
<h3 id="execution-scenarios-requiring-runtime-lookup">Execution Scenarios Requiring Runtime Lookup</h3>
<ol>
<li>Process-like Operations (<code>fork</code>, <code>exec</code>, <code>exit</code>)</li>
</ol>
<p>Operations such as fork, exec, and exit require Wasmtime instances to be created, cloned, or destroyed. However, the logic that performs the semantic handling of these operations may execute in a different cage or grate than the one that originally issued the system call.</p>
<p>After RawPOSIX completes the semantic work, control must return to Wasmtime, not necessarily to the instance that initiated the call.
As a result, lind-3i cannot rely on an implicit “current” runtime state. Instead, it must explicitly retrieve the correct execution context:</p>
<p>For <code>fork</code>, <code>exec</code>, and <code>exit</code>, these operations conceptually create,replace, or terminate the execution state of a process. After RawPOSIX completes the semantic handling, lind-wasm must resume execution in a Wasmtime instance associated with an <em>arbitrary</em> <code>cage_id</code>, which may differ from the calling cage. The appropriate runtime context is therefore retrieved by directly looking up the execution context associated with the target <code>cage_id</code>.</p>
<ol start="2">
<li>Thread-like Operations</li>
</ol>
<p>Thread operations introduce additional execution contexts within the same cage. These contexts are not part of the main execution flow and cannot be recovered via a global “current” state. Instead, lind-wasm explicitly looks up the runtime context associated with the corresponding <code>(cage_id, tid)</code> pair, ensuring correct control-flow transfer during thread creation, scheduling, and termination.</p>
<ol start="2">
<li>Grate Calls (Cross-Module Execution Transfers)</li>
</ol>
<p>Grate calls represent explicit execution jumps between Wasm modules, such as:</p>
<ul>
<li>Cage -&gt; Grate</li>
<li>Grate -&gt; RawPOSIX</li>
<li>Grate -&gt; Grate</li>
</ul>
<p>These jumps are not standard Wasm function calls and cannot rely on a shared call stack or <code>Store</code>. Supporting them requires the ability to (1) Locate a runtime state belonging to a different module, and (2) Re-enter Wasm execution from outside the original stack frame. To achieve this, lind-wasm relies on the following invariant: Each Wasmtime <code>Store</code> contains exactly one Wasm <code>Instance</code>, and each thread executes within its own independent <code>Store</code> / <code>Instance</code> pair. The Wasmtime <code>VMContext</code> pointer uniquely identifies the execution state of a running instance. Given a valid <code>VMContext</code>, lind-wasm can recover the associated <code>Store</code> and <code>Instance</code> using Wasmtime internals. Moreover, since <code>VMContext</code> is the raw pointer, it also helps lind-wasm bypass the lifetime restriction of <code>Store</code> and <code>Instance</code>.</p>
<h4 id="data-structure">Data structure</h4>
<p>Because <code>VMContext</code> is opaque and lifetime-managed internally by Wasmtime, this module stores it as a raw pointer wrapped in a minimal abstraction:</p>
<div class="highlight"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">VmCtxWrapper</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">vmctx</span><span class="p">:</span><span class="w"> </span><span class="nc">NonNull</span><span class="o">&lt;</span><span class="n">c_void</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>Lind-Wasm maintains two global, per-cage pools of <code>VMContext</code> pointers:</p>
<ol>
<li><strong>General execution context lookup table</strong></li>
</ol>
<p>The global <code>VMCTX_QUEUES</code> structure primarily manages execution contexts for the <em>main thread</em> (<code>tid = 1</code>) of each cage and indexed by <code>cage_id</code>. Each cage owns a FIFO queue that stores the execution contexts currently available to it. The total number of cages is fixed at startup (<code>MAX_CAGEID</code>).</p>
<p>Importantly, table slots are never removed from the global pool. Instead, the <em>slot contents(the queue)</em> of each slot may be inserted or removed over time. When a cage terminates, its corresponding queue slot remains present, but its slot content is cleared and set to <code>None</code>.</p>
<p>This design ensures that each table index always directly corresponds to a <code>cage_id</code>, eliminating the need for dynamic index management or lookup structures. As a result, <code>cage_id</code> can be used as a stable, constant-time index into the pool, reducing lookup overhead and avoiding additional search or indirection costs.</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">VMCTX_QUEUES</span><span class="p">:</span><span class="w"> </span><span class="nc">OnceLock</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Mutex</span><span class="o">&lt;</span><span class="n">VecDeque</span><span class="o">&lt;</span><span class="n">VmCtxWrapper</span><span class="o">&gt;&gt;&gt;&gt;</span><span class="p">;</span>
</code></pre></div>
<ol start="2">
<li><strong>Thread Handling and Execution Context Lookup</strong></li>
</ol>
<p>To support thread-related operations, lind-wasm maintains a separate, thread-specific execution context table. This table is used <em>only</em> for non-main threads (<code>tid != 1</code>) and exists to support thread-related syscalls and thread <code>exit</code>. Each <code>(cage_id, tid)</code> maps to at most one <code>VMContext</code>. No pooling is performed. This table is not consulted for normal execution or grate calls.</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">VMCTX_THREADS</span><span class="p">:</span><span class="w"> </span><span class="nc">OnceLock</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Mutex</span><span class="o">&lt;</span><span class="n">HashMap</span><span class="o">&lt;</span><span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">VmCtxWrapper</span><span class="o">&gt;&gt;&gt;&gt;</span><span class="p">;</span>
</code></pre></div>
<h4 id="execution-flow">Execution Flow</h4>
<p>[todo] 
- use cases, end-to-end steps (first) --&gt; explain each steps after that </p>
<p>[ Cage A ]
   │
   │  (system call / grate call)
   ▼
┌──────────────┐
│      3i      │
│ (dispatcher) │
└──────────────┘
   │
   │ redirect to wasmtime by <code>MAKE_SYSCALL</code>
   │
   ▼
┌──────────────┐
│   wasmtime   │
│              │
└──────────────┘
   │
   │ lookup target <code>cage_id</code>
   │
   ▼
┌────────────────────────────┐
│  Global VMContext Pool     │
│  get_vmctx(<code>cage_id</code> = G)  │
└────────────────────────────┘
   │
   │ returns <code>VmCtxWrapper</code>
   │ (raw <code>VMContext*</code>)
   ▼
┌────────────────────────────┐
│   Wasmtime internals       │
│  recover <code>Store</code>/<code>Instance</code>│
│   from VMContext pointer   │
└────────────────────────────┘
   │
   │ enter wasm execution
   ▼
[ Grate G ]
   │
   │ Return
   ▼
┌────────────────────────────┐
│   Wasmtime internals       │
│set_vmctx(cageid, VMContext)│
│  put VMContext back to pool│
└────────────────────────────┘</p>
<p><strong>Callback Definition (Wasmtime side):</strong></p>
<p>The C-ABI callback function knows how to re-enter the Wasm module via the unified entry function.</p>
<p><strong>Handler Registration:</strong></p>
<p>When the Wasm module calls <code>register_handler()</code>, the redirection information entry is extracted and passed to 3i.</p>
<p><strong>Cross-Cage Invocation:</strong></p>
<p>When a syscall from <em>cage A</em> is routed to <em>grate B</em>:</p>
<ol>
<li>the regular syscall reaches 3i via <code>make_syscall</code></li>
<li>3i looks up the <code>cageid</code> entry for B, and lookup corresponding runtime function pointer for <code>cageid</code></li>
<li>3i directly invokes the function pointer, re-entering the target Wasm instance through Wasmtime’s runtime context.</li>
</ol>
<p><strong>Dispatch Inside Grate:</strong></p>
<p>The Wasm entry function (in module) receives a pointer identifying the target handler and dispatches control to the correct per-syscall implementation.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["content.action.edit"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>