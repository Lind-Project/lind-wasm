#!/usr/bin/env bash
set -Eeuo pipefail

# Run passed (optionally precompiled) wasm file in wasmtime.
#
# Usage:
#   lind_run /path/to/program.[c]wasm
#   ./scripts/lind_run ./foo.cwasm
#
# No assumption about current working directory.

# --- repo root discovery (env var -> script dir -> git) ---
if [[ -n "${LIND_WASM_ROOT:-}" && -d "${LIND_WASM_ROOT}" ]]; then
  REPO_ROOT="${LIND_WASM_ROOT}"
else
  SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
  if [[ -f "${SCRIPT_DIR}/../Makefile" ]]; then
    REPO_ROOT="$(cd -- "${SCRIPT_DIR}/.." && pwd)"
  else
    if command -v git >/dev/null 2>&1; then
      REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || true)"
    else
      REPO_ROOT=""
    fi
  fi
fi

if [[ -z "${REPO_ROOT}" || ! -d "${REPO_ROOT}" ]]; then
  echo "ERROR: Could not locate lind-wasm repo root." >&2
  echo "Hint: export LIND_WASM_ROOT=/path/to/lind-wasm" >&2
  exit 2
fi

WASMTIME_PROFILE="${WASMTIME_PROFILE:-release}"
WASMTIME_BIN="${REPO_ROOT}/src/wasmtime/target/${WASMTIME_PROFILE}/wasmtime"
# Fallback to release if selected profile isn't built yet
if [[ ! -x "${WASMTIME_BIN}" ]]; then
  ALT="${REPO_ROOT}/src/wasmtime/target/release/wasmtime"
  [[ -x "${ALT}" ]] && WASMTIME_BIN="${ALT}"
fi
[[ -x "${WASMTIME_BIN}" ]] || { echo "error: wasmtime not found at ${WASMTIME_BIN}" >&2; exit 2; }

# Get the wasm/cwasm file path from arguments
WASM_FILE="$1"

# Check if file argument is provided
if [[ -z "${WASM_FILE}" ]]; then
  echo "error: no wasm/cwasm file specified" >&2
  echo "usage: $(basename "$0") <file.cwasm> [args...]" >&2
  exit 2
fi

# Normalize to absolute path
if [[ "${WASM_FILE}" != /* ]]; then
  WASM_FILE="$(cd "$(dirname "${WASM_FILE}")" 2>/dev/null && pwd)/$(basename "${WASM_FILE}")"
  if [[ $? -ne 0 ]]; then
    echo "error: cannot resolve path: $1" >&2
    exit 2
  fi
fi

# Validate file is within LIND_ROOT
LIND_ROOT="${LIND_ROOT:-${REPO_ROOT}/src/tmp}"
LIND_ROOT_ABS="$(cd "${LIND_ROOT}" 2>/dev/null && pwd)"

if [[ -z "${LIND_ROOT_ABS}" ]]; then
  echo "error: LIND_ROOT not found at ${LIND_ROOT}" >&2
  echo "hint: run 'make prepare-lind-root' first" >&2
  exit 2
fi

if [[ "${WASM_FILE}" != "${LIND_ROOT_ABS}"* ]]; then
  echo "error: executable must be in LIND_ROOT" >&2
  echo "  File: ${WASM_FILE}" >&2
  echo "  LIND_ROOT: ${LIND_ROOT_ABS}" >&2
  echo "hint: compile with lind_compile to place executables in LIND_ROOT" >&2
  exit 2
fi

# Convert absolute system path to LIND_ROOT-relative path for argv[0]
LIND_RELATIVE_PATH="${WASM_FILE#${LIND_ROOT_ABS}}"
# Shift the first argument and replace it with the LIND-relative path
shift

exec "${WASMTIME_BIN}" run --allow-precompiled --wasi threads=y --wasi preview2=n \
  "${LIND_RELATIVE_PATH}" "$@"
