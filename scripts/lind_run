#!/usr/bin/env bash
set -Eeuo pipefail

# Run passed (optionally precompiled) wasm file in wasmtime.
#
# Usage:
#   lind_run /path/to/program.[c]wasm
#   ./scripts/lind_run ./foo.cwasm
#
# No assumption about current working directory.

# --- repo root discovery (env var -> script dir -> git) ---
if [[ -n "${LIND_WASM_ROOT:-}" && -d "${LIND_WASM_ROOT}" ]]; then
  REPO_ROOT="${LIND_WASM_ROOT}"
else
  SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
  if [[ -f "${SCRIPT_DIR}/../Makefile" ]]; then
    REPO_ROOT="$(cd -- "${SCRIPT_DIR}/.." && pwd)"
  else
    if command -v git >/dev/null 2>&1; then
      REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || true)"
    else
      REPO_ROOT=""
    fi
  fi
fi

if [[ -z "${REPO_ROOT}" || ! -d "${REPO_ROOT}" ]]; then
  echo "ERROR: Could not locate lind-wasm repo root." >&2
  echo "Hint: export LIND_WASM_ROOT=/path/to/lind-wasm" >&2
  exit 2
fi

WASMTIME_BIN="${REPO_ROOT}/build/wasmtime"
if [[ ! -x "${WASMTIME_BIN}" ]]; then
  echo "ERROR: wasmtime missing: ${WASMTIME_BIN}" >&2
  exit 127 # Note: This is the traditional "command not found" exit code, can be changed as needed
fi

# Check if we need to re-exec with sudo
if [[ $EUID -ne 0 ]]; then
  # Not running as root, re-exec with sudo
  exec sudo -E "$0" "$@"
fi

exec "${WASMTIME_BIN}" run --allow-precompiled --wasi threads=y --wasi preview2=n "$@"
