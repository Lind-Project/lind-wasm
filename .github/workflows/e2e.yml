name: End-to-end testing

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches:
      - main

permissions:
  pull-requests: write

jobs:
  docker:
    # If the workflow was triggered by anything other than a pull_request event 
    # (e.g., push, workflow_dispatch, schedule, pull_request_target), 
    # github.event_name != 'pull_request' is true.
    # github.event.pull_request is only populated on pull_request events. 
    # It is true when the PR is not a draft (i.e., “Ready for review”).
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    env:
      REPORT_PATH_IN_IMAGE: /report.html
      REPORT_LOCAL_DIR: test-reports
      REPORT_LOCAL_FILE: wasm-e2e-report.html
      
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1
      - name: Build e2e
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          file: Docker/Dockerfile.e2e
          load: true
          tags: e2e:latest
      - name: Extract HTML report and markdown summary from built image
        run: |
          set -euo pipefail
          mkdir -p "$REPORT_LOCAL_DIR"
          cid="$(docker create e2e:latest)"
          trap 'docker rm -f "$cid" > /dev/null 2>&1 || true' EXIT

          # Extract the HTML report
          docker cp "$cid":"$REPORT_PATH_IN_IMAGE" "$REPORT_LOCAL_DIR/$REPORT_LOCAL_FILE"
          ls -l "${REPORT_LOCAL_DIR}/${REPORT_LOCAL_FILE}"          
          
          # Copy the rendered Markdown back out to host
          HOST_OUT="${{ github.workspace }}/${{ env.REPORT_LOCAL_DIR }}"
          docker run --rm \
            --mount type=bind,src="$HOST_OUT",dst=/out \
            e2e:latest \
            sh -lc '              
              python3 -m pip install --quiet jinja2 &&
              python3 scripts/render_e2e_templates.py &&
              cp -v test-reports/e2e_comment.md /out/e2e_comment.md
            '
          ls -l "$HOST_OUT/e2e_comment.md"
      - name: Upload HTML report artifact to report
        uses: actions/upload-artifact@v4
        with:
          name: wasm-e2e-report
          path: ${{ env.REPORT_LOCAL_DIR }}/${{ env.REPORT_LOCAL_FILE }}
          if-no-files-found: error
          retention-days: 7
      
      - name: Post PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('test-reports/e2e_comment.md','utf8');
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            await github.rest.issues.createComment({ owner, repo, issue_number, body });